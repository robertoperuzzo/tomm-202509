# ADR-016: Marker Extractor JSON Structure Standardization

## Status

Proposed

## Context

During analysis of the preprocessing pipeline output, a significant structural inconsistency was discovered between the JSON files generated by different extraction methods. While the `unstructured`, `pypdf`, and `markitdown` extractors produce a standardized flat JSON structure, the `marker` extractor generates a nested structure that breaks compatibility with downstream processing systems.

### Current Issue

**Standard Structure (unstructured, pypdf, markitdown):**

```json
{
  "document_id": "9308101_DynamicBacktracking",
  "original_filename": "9308101_Dynamic Backtracking.pdf",
  "processed_at": "2025-09-05T10:52:29.875094",
  "extraction_method": "unstructured",
  "title": "9308101 Dynamic Backtracking",
  "authors": [],
  "full_text": "...",
  "text_length": 44238,
  "metadata": { ... },
  "performance_metrics": { ... },
  "quality_metrics": { ... },
  "method_specific_data": { ... }
}
```

**Problematic Structure (marker):**

```json
{
  "file_metadata": {
    "original_filename": "...",
    "file_extension": ".pdf",
    ...
  },
  "extraction_metadata": {
    "extraction_method": "marker",
    "file_format": ".pdf",
    "timestamp": "20250911_092304",
    "performance_metrics": { ... },
    "quality_metrics": { ... }
  },
  "method_specific_data": { ... }
}
```

### Root Cause Analysis

The inconsistency stems from how the `MarkerExtractor` constructs its `ExtractionResult` object. While other extractors align with the JSON creation logic in `scripts/demo_preprocessing_enhanced.py` that expects a flat structure, the marker extractor returns nested metadata that doesn't map correctly to the expected output format.

### Options Considered

1. **Modify Marker Extractor (Recommended)**: Update the marker extractor to return data compatible with the standard JSON structure
2. **Update JSON Creation Logic**: Modify preprocessing scripts to handle marker's nested structure
3. **Standardize Through Base Class**: Create a unified output formatter in the base extractor class

## Decision

We will implement **Option 1: Modify Marker Extractor** to ensure structural consistency across all extraction methods.

### Rationale

- **Minimal Impact**: Changes are isolated to the marker extractor implementation
- **Maintains Compatibility**: Existing JSON files from other extractors remain unaffected
- **Clear Responsibility**: The extractor is responsible for providing data in the expected format
- **Follows Existing Patterns**: Aligns with how other extractors already work
- **Future-Proof**: New extractors will follow the established pattern

## Implementation Plan

### Phase 1: Update MarkerExtractor Structure

1. **Modify `src/preprocessor/extractors/marker_extractor.py`**:

   - Update the `extract()` method to return `ExtractionResult` with flat metadata structure
   - Ensure compatibility with the JSON creation logic in `demo_preprocessing_enhanced.py`
   - Move file metadata from nested `file_metadata` to the standard format expected by the JSON creator

2. **Specific Changes Required**:

   ```python
   # Current problematic return in marker_extractor.py
   return ExtractionResult(
       text=text,
       performance_metrics=performance_metrics,
       quality_metrics=quality_metrics,
       method_specific_data={
           "file_metadata": {...},
           "extraction_metadata": {...},
           ...
       }
   )

   # Should be changed to align with standard structure
   return ExtractionResult(
       text=text,
       performance_metrics=performance_metrics,
       quality_metrics=quality_metrics,
       method_specific_data={
           'extraction_method': 'marker',
           'file_format': file_path.suffix.lower(),
           'output_format': self.config.output_format,
           'marker_version': self._get_marker_version(),
           'llm_enhanced': self.config.use_llm,
           # Other marker-specific data only
       }
   )
   ```

### Phase 2: Validation and Testing

1. **Test JSON Structure Consistency**:

   - Process the same document with all four extraction methods
   - Verify that all generated JSON files have identical top-level structure
   - Ensure `document_id`, `original_filename`, `processed_at`, `extraction_method`, etc. are at root level

2. **Backward Compatibility**:

   - Verify existing marker JSON files can be identified and potentially migrated
   - Document any breaking changes for users with existing marker-processed files

3. **Integration Testing**:
   - Test with downstream chunking pipeline
   - Verify indexing compatibility
   - Ensure search functionality works with updated structure

### Phase 3: Documentation

1. **Update Documentation**:
   - Update preprocessing documentation to reflect standardized structure
   - Update API documentation

## Consequences

### Positive

- **Structural Consistency**: All extraction methods produce identical JSON schema
- **Simplified Processing**: Downstream systems can rely on consistent structure
- **Interchangeable Methods**: Users can switch between extraction methods without code changes
- **Easier Maintenance**: Single JSON schema to maintain and validate

### Negative

- **Breaking Change**: Existing marker-generated JSON files will have different structure
- **Temporary Inconsistency**: During rollout, mixed file formats may exist

### Mitigation Strategies

- Provide clear migration documentation and tools
- Version the JSON schema to detect and handle legacy formats
- Implement backward compatibility in critical downstream systems during transition period

## Timeline

- **Week 1**: Implement marker extractor changes
- **Week 2**: Testing and validation
- **Week 3**: Documentation updates
- **Week 4**: Deployment and monitoring

## Success Criteria

1. All four extraction methods produce JSON files with identical top-level structure
2. Existing downstream processing (chunking, indexing) works seamlessly with marker-extracted files
3. No regression in marker extraction quality or performance

## Related ADRs

- ADR-008: Marker Integration for Enhanced PDF Processing
- ADR-006: PDF Extraction Standardization
- ADR-003: Preprocessing Architecture Refactoring

## References

- Analysis of existing JSON structures in `data/processed/` directories
- `src/preprocessor/extractors/marker_extractor.py` implementation
- `scripts/demo_preprocessing_enhanced.py` JSON creation logic
- Base extractor interface in `src/preprocessor/base.py`
